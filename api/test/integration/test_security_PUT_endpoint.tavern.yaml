---
test_name: PUT /security/roles

includes:
  - !include common.yaml

#marks:
#  - usefixtures:
#    - security_tests

stages:

  # Authentication stage
  - type: ref
    id: login_get_token

  # PUT /security/roles/{role_id}
  - name: Modify a role in the system
    request: &modify_role_request
      url: "{protocol:s}://{host:s}:{port:d}/security/roles/3"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        name: "testModified"
        rule:
          MATCH:
            normal_user: "get_permissionsM"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - id: 3
              name: testModified
              policies: !anything
              rule:
                MATCH:
                  normal_user: "get_permissionsM"
          total_affected_items: 1

  # PUT /security/roles/{role_id}
  - name: Modify a role in the system (without change rule)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/roles/4"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        name: "testModified2"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - id: 4
              name: testModified2
              policies:
                - id: 2
                  name: test_i
                  policy:
                    actions:
                      - agent:delete
                    effect: allow
                    resources:
                      - agent:id:004
                      - agent:id:005
                      - agent:id:006
              rule:
                FIND:
                  definition: normal_rule1
          failed_items: []
          total_affected_items: 1
          total_failed_items: 0
        message: Role updated correctly

  # PUT /security/roles/{role_id}
  - name: Modify a role in the system (without change name)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/roles/3"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        rule:
          MATCH:
            normal_user: "get_permissionsM2"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - id: 3
              name: testModified
              policies: !anything
              rule:
                MATCH:
                  normal_user: "get_permissionsM2"
          total_affected_items: 1

  # PUT /security/roles/{non-existent role_id}
  - name: Modify a non-existent role in the system
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/roles/999"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        name: "Unexistent"
        rule:
          user: "no"
    response:
      status_code: 200
      body:
        data:
          affected_items: []
          failed_items:
            - error:
                code: 4002
                message: !anystr
                remediation: !anystr
              id:
                - 999
          total_affected_items: 0
          total_failed_items: 1
        message: !anystr
---
test_name: PUT /security/policies

stages:

  # PUT /security/policies/{policy_id}
  - name: Modify a policy in the system
    request: &modify_policy_request
      url: "{protocol:s}://{host:s}:{port:d}/security/policies/2"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        name: "testModifiedPolicy"
        policy:
          actions:
            - "agent:delete"
          resources:
            - "agent:id:001"
            - "agent:id:002"
            - "agent:id:003"
          effect: "allow"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - id: 2
              name: testModifiedPolicy
              policy:
                actions:
                  - agent:delete
                effect: allow
                resources:
                  - agent:id:001
                  - agent:id:002
                  - agent:id:003
              roles: !anything
          total_affected_items: 1

  # PUT /security/policies/{policy_id}
  - name: Modify a policy in the system (without change policy definition)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/policies/2"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        name: "testModifiedPolicy2"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - id: 2
              name: testModifiedPolicy2
              policy:
                actions:
                  - agent:delete
                effect: allow
                resources:
                  - agent:id:001
                  - agent:id:002
                  - agent:id:003
              roles: !anything
          total_affected_items: 1

  # PUT /security/policies/{policy_id}
  - name: Modify a policy in the system (without change name)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/policies/2"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        policy:
          actions:
            - "agent:delete"
          resources:
            - "agent:id:001"
            - "agent:id:002"
            - "agent:id:003"
          effect: "deny"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - id: 2
              name: testModifiedPolicy2
              policy:
                actions:
                  - agent:delete
                effect: deny
                resources:
                  - agent:id:001
                  - agent:id:002
                  - agent:id:003
              roles: !anything
          total_affected_items: 1

  # PUT /security/policies/{non-existent policy_id}
  - name: Modify a non-existent policy in the system
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/policies/999"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        name: "Unexistent"
        policy:
          actions:
            - "agent:delete"
          resources:
            - "agent:id:001"
            - "agent:id:002"
            - "agent:id:003"
          effect: "allow"
    response:
      status_code: 200
      body:
        data:
          affected_items: []
          failed_items:
            - error:
                code: 4007
                message: !anystr
                remediation: !anystr
              id:
                - 999
          total_affected_items: 0
          total_failed_items: 1
        message: !anystr

  # PUT /security/policies/{non-existent policy_id}
  - name: Modify a policy in the system, bad policy definition
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/policies/2"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
      json:
        name: "incorrect"
        policy:
          actions:
            - "agent:delete"
          resources:
            - "agent:id:001:"
            - "agent:id:002"
            - "agent:id:003"
    response:
      status_code: 400

---
test_name: PUT /security/user/revoke

stages:

  - name: Revoke all tokens
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/user/revoke"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
    response:
      status_code: 200

  - name: Revoke all tokens (Invalid token after previous call)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/security/user/revoke"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: PUT
    response:
      status_code: 401
